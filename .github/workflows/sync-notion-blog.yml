name: Notion Blog ìë™ ë™ê¸°í™”

on:
  # 6ì‹œê°„ë§ˆë‹¤ ìë™ ì‹¤í–‰ (UTC ê¸°ì¤€: 00:00, 06:00, 12:00, 18:00)
  schedule:
    - cron: '0 */6 * * *'
  
  # ìˆ˜ë™ íŠ¸ë¦¬ê±° ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-notion:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ uv ì„¤ì¹˜
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true

    - name: ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜
      run: uv pip install --system -r requirements.txt

    - name: ğŸ” í™˜ê²½ ë³€ìˆ˜ í™•ì¸
      run: |
        echo "NOTION_TOKEN ì„¤ì • ì—¬ë¶€: ${{ secrets.NOTION_TOKEN != '' }}"
        echo "NOTION_DATABASE_ID ì„¤ì • ì—¬ë¶€: ${{ secrets.NOTION_DATABASE_ID != '' }}"
        echo "í˜„ì¬ ì‹œê°„ (UTC): $(date -u)"
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

    - name: ğŸ”„ Notion ë™ê¸°í™” ì‹¤í–‰
      run: |
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "ğŸ§ª Dry run ëª¨ë“œë¡œ ì‹¤í–‰"
          python sync_notion.py --dry-run
        else
          echo "ğŸš€ ì‹¤ì œ ë™ê¸°í™” ì‹¤í–‰"
          python sync_notion.py
        fi
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¤ ë³€ê²½ì‚¬í•­ í‘¸ì‹œ (if any)
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ë°œê²¬, ì»¤ë°‹ ì¤‘..."
          git add -A
          git commit -m "auto: Notion ë¸”ë¡œê·¸ ìë™ ë™ê¸°í™” $(date -u +'%Y-%m-%d %H:%M:%S') UTC

ğŸ¤– Generated with GitHub Actions
Co-Authored-By: GitHub Actions <action@github.com>"
          git push
          echo "âœ… ë³€ê²½ì‚¬í•­ í‘¸ì‹œ ì™„ë£Œ"
        else
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        fi

  deploy-to-fly:
    needs: sync-notion
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run != 'true'
    
    steps:
    - name: ğŸ“‚ ì²´í¬ì•„ì›ƒ (ìµœì‹ )
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0

    - name: ğŸš fly.io ì„¤ì •
      uses: superfly/flyctl-actions/setup-flyctl@master

    - name: ğŸš€ fly.io ë°°í¬
      run: flyctl deploy --remote-only
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

    - name: ğŸ‰ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: success()
      run: |
        echo "âœ… fly.io ë°°í¬ ì„±ê³µ!"
        echo "ğŸŒ ì‚¬ì´íŠ¸ URL: https://your-app-name.fly.dev"
      
    - name: âŒ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼  
      if: failure()
      run: |
        echo "âŒ fly.io ë°°í¬ ì‹¤íŒ¨"
        echo "ğŸ”§ ìˆ˜ë™ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤"